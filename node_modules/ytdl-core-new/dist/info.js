"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const cache_1 = require("./cache");
const urllib = __importStar(require("url"));
const qs = __importStar(require("qs"));
const sax_1 = __importDefault(require("sax"));
const util = __importStar(require("./util"));
const extras = __importStar(require("./info-extras"));
const sig = __importStar(require("./sig"));
const lru_cache_1 = __importDefault(require("lru-cache"));
const client_1 = __importDefault(require("./client"));
const VIDEO_URL = 'https://www.youtube.com/watch?v=';
const EMBED_URL = 'https://www.youtube.com/embed/';
const VIDEO_EURL = 'https://youtube.googleapis.com/v/';
const INFO_HOST = 'www.youtube.com';
const INFO_PATH = '/get_video_info';
/**
 * Gets info from a video without getting additional formats.
 */
exports._getBasicInfo = (id, options = {}) => __awaiter(void 0, void 0, void 0, function* () {
    var _a, _b;
    // Try getting config from the video page first.
    const params = 'hl=' + (_a = options.lang, (_a !== null && _a !== void 0 ? _a : 'en'));
    let url = VIDEO_URL + id + '&' + params +
        '&bpctr=' + Math.ceil(Date.now() / 1000);
    // Remove header from watch page request.
    // Otherwise, it'll use a different framework for rendering content.
    const reqOptions = Object.assign({}, (_b = options.requestOptions, (_b !== null && _b !== void 0 ? _b : {})));
    reqOptions.headers = Object.assign({}, reqOptions.headers, {
        'User-Agent': '',
    });
    const resp = yield client_1.default.get(url, reqOptions);
    const body = resp.data;
    // Check if there are any errors with this video page.
    const unavailableMsg = util.between(body, '<div id="player-unavailable"', '>');
    if (unavailableMsg &&
        !/\bhid\b/.test(util.between(unavailableMsg, 'class="', '"'))) {
        // Ignore error about age restriction.
        if (!body.includes('<div id="watch7-player-age-gate-content"')) {
            throw new Error(util.between(body, '<h1 id="unavailable-message" class="message">', '</h1>').trim());
        }
    }
    // Parse out additional metadata from this page.
    const additional = {
        // Get the author/uploader.
        author: extras.getAuthor(body),
        // Get the day the vid was published.
        published: extras.getPublished(body),
        // Get description.
        description: extras.getVideoDescription(body),
        // Get media info.
        media: extras.getVideoMedia(body),
        // Get related videos.
        related_videos: extras.getRelatedVideos(body),
        // Get likes.
        likes: extras.getLikes(body),
        // Get dislikes.
        dislikes: extras.getDislikes(body),
    };
    const jsonStr = util.between(body, 'ytplayer.config = ', '</script>');
    let config;
    if (jsonStr) {
        config = jsonStr.slice(0, jsonStr.lastIndexOf(';ytplayer.load'));
        return gotConfig(id, options, additional, config, false);
    }
    // If the video page doesn't work, maybe because it has mature content.
    // and requires an account logged in to view, try the embed page.
    url = EMBED_URL + id + '?' + params;
    const resp2 = yield client_1.default.get(url, options.requestOptions);
    config = util.between(resp2.data, 't.setConfig({\'PLAYER_CONFIG\': ', /\}(,'|\}\);)/);
    return gotConfig(id, options, additional, config, true);
});
const parseFormats = (info) => {
    let formats = [];
    if (info.player_response.streamingData) {
        if (info.player_response.streamingData.formats) {
            formats = formats.concat(info.player_response.streamingData.formats);
        }
        if (info.player_response.streamingData.adaptiveFormats) {
            formats = formats.concat(info.player_response.streamingData.adaptiveFormats);
        }
    }
    return formats;
};
const gotConfig = (id, options, additional, config, fromEmbed) => __awaiter(void 0, void 0, void 0, function* () {
    var _c;
    if (!config) {
        throw new Error('Could not find player config');
    }
    try {
        config = JSON.parse(config + (fromEmbed ? '}' : ''));
    }
    catch (err) {
        throw new Error('Error parsing config: ' + err.message);
    }
    const url = urllib.format({
        protocol: 'https',
        host: INFO_HOST,
        pathname: INFO_PATH,
        query: {
            video_id: id,
            eurl: VIDEO_EURL + id,
            ps: 'default',
            gl: 'US',
            hl: (options.lang || 'en'),
            sts: config.sts,
        },
    });
    const resp = yield client_1.default.get(url, options.requestOptions);
    const body = resp.data;
    const info = qs.parse(body);
    const player_response = config.args.player_response || info.player_response;
    if (info.status === 'fail') {
        throw new Error(`Code ${info.errorcode}: ${util.stripHTML(info.reason)}`);
    }
    else {
        try {
            info.player_response = JSON.parse(player_response);
        }
        catch (err) {
            throw new Error('Error parsing `player_response`: ' + err.message);
        }
    }
    const playability = info.player_response.playabilityStatus;
    if (playability && playability.status === 'UNPLAYABLE') {
        throw new Error(util.stripHTML(playability.reason));
    }
    return Object.assign(Object.assign(Object.assign({}, info), additional), { formats: parseFormats(info), video_id: id, 
        // Give the standard link to the video.
        video_url: VIDEO_URL + id, 
        // Copy over a few props from `player_response.videoDetails`
        // for backwards compatibility.
        title: info.player_response.videoDetails && info.player_response.videoDetails.title, length_seconds: info.player_response.videoDetails && info.player_response.videoDetails.lengthSeconds, age_restricted: fromEmbed, html5player: (_c = config.assets) === null || _c === void 0 ? void 0 : _c.js });
});
/**
 * Gets info from a video additional formats and deciphered URLs.
 */
exports._getFullInfo = (id, options = {}) => __awaiter(void 0, void 0, void 0, function* () {
    const info = yield exports.getBasicInfo(id, options);
    const hasManifest = info.player_response && info.player_response.streamingData && (!!info.player_response.streamingData.dashManifestUrl ||
        !!info.player_response.streamingData.hlsManifestUrl);
    if (info.formats.length || hasManifest) {
        const html5playerfile = urllib.resolve(VIDEO_URL, info.html5player);
        const tokens = yield sig.getTokens(html5playerfile, options);
        sig.decipherFormats(info.formats, tokens, options.debug);
        const promises = [];
        if (hasManifest && info.player_response.streamingData.dashManifestUrl) {
            let url = info.player_response.streamingData.dashManifestUrl;
            promises.push(getDashManifest(url, options));
        }
        if (hasManifest && info.player_response.streamingData.hlsManifestUrl) {
            let url = info.player_response.streamingData.hlsManifestUrl;
            promises.push(getM3U8(url, options));
        }
        const results = yield Promise.all(promises);
        if (results[0]) {
            mergeFormats(info, results[0]);
        }
        if (results[1]) {
            mergeFormats(info, results[1]);
        }
        info.formats = info.formats.map(util.addFormatMeta).sort(util.sortFormats);
        info.full = true;
        return info;
    }
    throw new Error('This video is unavailable');
});
/**
 * Merges formats from DASH or M3U8 with formats from video info page.
 *
 * @param {Object} info
 * @param {Object} formatsMap
 */
const mergeFormats = (info, formatsMap) => {
    info.formats.forEach((f) => {
        formatsMap[f.itag] = formatsMap[f.itag] || f;
    });
    info.formats = Object.values(formatsMap);
};
/**
 * Gets additional DASH formats.
 *
 * @param {string} url
 * @param {Object} options
 * @param {Function(!Error, Array.<Object>)} callback
 */
const getDashManifest = (url, options) => __awaiter(void 0, void 0, void 0, function* () {
    let formats = {};
    const parser = sax_1.default.parser(false);
    return new Promise((resolve, reject) => {
        parser.onerror = reject;
        parser.onopentag = (node) => {
            if (node.name === 'REPRESENTATION') {
                const itag = node.attributes.ID;
                formats[itag] = { itag, url };
            }
        };
        parser.onend = () => resolve(formats);
        client_1.default.get(urllib.resolve(VIDEO_URL, url), options.requestOptions)
            .then((resp) => {
            parser.write(resp.data);
            parser.close();
        })
            .catch(reject);
    });
});
/**
 * Gets additional formats.
 *
 * @param {string} url
 * @param {Object} options
 * @param {Function(!Error, Array.<Object>)} callback
 */
const getM3U8 = (url, options) => __awaiter(void 0, void 0, void 0, function* () {
    url = urllib.resolve(VIDEO_URL, url);
    const resp = yield client_1.default.get(url, options.requestOptions);
    const body = resp.data;
    return body
        .split('\n')
        .filter((line) => /https?:\/\//.test(line))
        .reduce((formats, line) => {
        const itag = line.match(/\/itag\/(\d+)\//)[1];
        formats[itag] = { itag, url: line };
        return formats;
    }, {});
});
// Cached for getting basic/full info.
exports.cache = new lru_cache_1.default({
    max: 10,
    maxAge: 600,
});
// Cache get info functions.
// In case a user wants to get a video's info before downloading.
const generateKeyFn = (fnName) => ([id, options]) => {
    var _a, _b;
    return `${fnName}-${id}-${_b = (_a = options) === null || _a === void 0 ? void 0 : _a.lang, (_b !== null && _b !== void 0 ? _b : 'en')}`;
};
const remapArgs = ([link, options]) => {
    const id = util.getVideoID(link);
    return [id, (options !== null && options !== void 0 ? options : {})];
};
exports.getBasicInfo = cache_1.applyCache(exports.cache, exports._getBasicInfo, generateKeyFn('getBasicInfo'), remapArgs);
exports.getFullInfo = cache_1.applyCache(exports.cache, exports._getFullInfo, generateKeyFn('getFullInfo'), remapArgs);
// Export a few helpers.
exports.validateID = util.validateID;
exports.validateURL = util.validateURL;
exports.getURLVideoID = util.getURLVideoID;
exports.getVideoID = util.getVideoID;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5mby5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9pbmZvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG1DQUFxQztBQUNyQyw0Q0FBOEI7QUFDOUIsdUNBQXlCO0FBQ3pCLDhDQUFzQjtBQUV0Qiw2Q0FBK0I7QUFDL0Isc0RBQXdDO0FBQ3hDLDJDQUE2QjtBQUU3QiwwREFBNEI7QUFDNUIsc0RBQStCO0FBRS9CLE1BQU0sU0FBUyxHQUFHLGtDQUFrQyxDQUFDO0FBQ3JELE1BQU0sU0FBUyxHQUFHLGdDQUFnQyxDQUFDO0FBQ25ELE1BQU0sVUFBVSxHQUFHLG1DQUFtQyxDQUFDO0FBQ3ZELE1BQU0sU0FBUyxHQUFHLGlCQUFpQixDQUFDO0FBQ3BDLE1BQU0sU0FBUyxHQUFHLGlCQUFpQixDQUFDO0FBRXBDOztHQUVHO0FBQ1UsUUFBQSxhQUFhLEdBQUcsQ0FBTyxFQUFVLEVBQUUsVUFBMkIsRUFBRSxFQUFzQixFQUFFOztJQUNuRyxnREFBZ0Q7SUFDaEQsTUFBTSxNQUFNLEdBQUcsS0FBSyxHQUFHLE1BQUMsT0FBTyxDQUFDLElBQUksdUNBQUksSUFBSSxFQUFDLENBQUM7SUFDOUMsSUFBSSxHQUFHLEdBQUcsU0FBUyxHQUFHLEVBQUUsR0FBRyxHQUFHLEdBQUcsTUFBTTtRQUNyQyxTQUFTLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFFM0MseUNBQXlDO0lBQ3pDLG9FQUFvRTtJQUNwRSxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsUUFBRSxPQUFPLENBQUMsY0FBYyx1Q0FBSSxFQUFFLEdBQUMsQ0FBQztJQUNuRSxVQUFVLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFVBQVUsQ0FBQyxPQUFPLEVBQUU7UUFDekQsWUFBWSxFQUFFLEVBQUU7S0FD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